{% extends "base.html" %}

{% block title %}{{ build.title }} — Бенчмарк Клуб{% endblock %}

{% block content %}
  <article class="grid">
    <header class="header-row">
      <div>
        <h1>{{ build.title }}</h1>
        <p class="card__meta">
          Автор:
          {% if build.allow_profile_link() %}
            <a href="{{ url_for('main.expert_profile', user_id=build.author_id) }}">{{ build.display_author_name() }}</a>
          {% else %}
            {{ build.display_author_name() }}
          {% endif %}
          · {{ build.created_at.strftime('%d.%m.%Y') }}
        </p>
        {% if build.is_anonymous %}
          <p class="hint">Автор предпочёл остаться анонимным.</p>
        {% endif %}
      </div>
      {% if current_user.is_authenticated and current_user.id == build.author_id %}
        <div class="actions">
          <a class="btn" href="{{ url_for('builds.edit', build_id=build.id) }}">Редактировать</a>
          <form method="post" action="{{ url_for('builds.delete', build_id=build.id) }}" onsubmit="return confirm('Удалить сборку?')">
            {{ csrf_token() }}
            <button class="btn btn-danger" type="submit">Удалить</button>
          </form>
        </div>
      {% endif %}
    </header>

    <section class="card">
      {% if build.cover_image %}
        <div class="cover">
          <img src="{{ url_for('media.uploaded_file', filename=build.cover_image) }}" alt="Обложка сборки {{ build.title }}">
        </div>
      {% endif %}
      <h2>Описание</h2>
      <p>{{ build.description }}</p>
      <h3>Конфигурация</h3>
      <pre class="hardware">{{ build.hardware_summary }}</pre>
      <div class="tags">
        {% for tag in build.tags %}
          <a class="tag" href="{{ url_for('builds.catalog', tag=tag.name) }}">#{{ tag.name }}</a>
        {% endfor %}
      </div>
      <p class="rating">
        Средняя оценка: {{ '%.1f'|format(build.average_rating()) if build.average_rating() else 'Еще нет оценок' }}
      </p>
    </section>

    {% if build.components %}
      <section class="card">
        <h2>Комплектующие и цены</h2>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Компонент</th>
                <th>DNS</th>
                <th>Мегамаркет</th>
                <th>М.Видео</th>
              </tr>
            </thead>
            <tbody>
              {% for component in build.components %}
                <tr>
                  <td>{{ component.name }}</td>
                  <td>
                    {% if component.dns_price %}
                      <span class="price">{{ '%.2f'|format(component.dns_price) }} ₽</span>
                      {% if component.dns_url %}
                        <a href="{{ component.dns_url }}" target="_blank" rel="noopener">Ссылка</a>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if component.megamarket_price %}
                      <span class="price">{{ '%.2f'|format(component.megamarket_price) }} ₽</span>
                      {% if component.megamarket_url %}
                        <a href="{{ component.megamarket_url }}" target="_blank" rel="noopener">Ссылка</a>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if component.mvideo_price %}
                      <span class="price">{{ '%.2f'|format(component.mvideo_price) }} ₽</span>
                      {% if component.mvideo_url %}
                        <a href="{{ component.mvideo_url }}" target="_blank" rel="noopener">Ссылка</a>
                      {% endif %}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    {% endif %}

    <section class="grid two-cols">
      <article class="card">
        <h2>Комментарии</h2>
        <form method="post">
          {{ comment_form.hidden_tag() }}
          <div class="form-group">
            {{ comment_form.content.label }}{{ comment_form.content(class="input input--textarea") }}
            {% for error in comment_form.content.errors %}<span class="error">{{ error }}</span>{% endfor %}
          </div>
          <div class="form-group checkbox">
            {{ comment_form.is_anonymous() }} {{ comment_form.is_anonymous.label }}
          </div>
          <button class="btn btn-accent" name="comment-submit" type="submit">{{ comment_form.submit.label.text }}</button>
        </form>
        <ul class="comment-list">
          {% for comment in build.comments|sort(attribute='created_at', reverse=True) %}
            <li>
              <strong>{{ comment.display_author_name() }}</strong>
              <span class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
              <p>{{ comment.content }}</p>
            </li>
          {% else %}
            <li>Комментарии еще не добавлены.</li>
          {% endfor %}
        </ul>
      </article>

      <article class="card">
        <h2>Оценки сообщества</h2>
        <form method="post">
          {{ rating_form.hidden_tag() }}
          <div class="form-group">
            {{ rating_form.score.label }}{{ rating_form.score(class="input") }}
            {% for error in rating_form.score.errors %}<span class="error">{{ error }}</span>{% endfor %}
          </div>
          <div class="form-group">
            {{ rating_form.feedback.label }}{{ rating_form.feedback(class="input input--textarea") }}
            {% for error in rating_form.feedback.errors %}<span class="error">{{ error }}</span>{% endfor %}
          </div>
          <div class="form-group checkbox">
            {{ rating_form.is_anonymous() }} {{ rating_form.is_anonymous.label }}
          </div>
          <button class="btn btn-accent" name="rating-submit" type="submit">{{ rating_form.submit.label.text }}</button>
        </form>
        <ul class="comment-list">
          {% for rating in build.ratings|sort(attribute='created_at', reverse=True) %}
            <li>
              <strong>{{ rating.display_reviewer_name() }}</strong> поставил {{ rating.score }}/5
              <span class="comment-date">{{ rating.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
              {% if rating.feedback %}<p>{{ rating.feedback }}</p>{% endif %}
            </li>
          {% else %}
            <li>Еще нет оценок. Оставьте отзыв первым!</li>
          {% endfor %}
        </ul>
      </article>
    </section>

    {% if subscribe_form and current_user.is_authenticated and current_user.id != build.author_id %}
      <section class="card">
        <h2>Подписки</h2>
        <form method="post">
          {{ subscribe_form.hidden_tag() }}
          {{ subscribe_form.target_id(value=build.author_id) }}
          <button class="btn {% if is_subscribed %}btn-danger{% else %}btn-accent{% endif %}" name="subscribe-submit" type="submit">
            {% if is_subscribed %}Отписаться{% else %}Подписаться{% endif %}
          </button>
        </form>
      </section>
    {% endif %}
  </article>
{% endblock %}

